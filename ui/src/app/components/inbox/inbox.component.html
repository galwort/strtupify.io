<div class="content-container">
  <div class="header">
    <div class="title">Inbox</div>
  </div>
  <div class="filter-container">
    <button class="filter-btn" (click)="openCompose()">
      <span class="material-symbols-outlined">add</span>
      <span class="label">NEW EMAIL</span>
    </button>
    <button
      class="filter-btn"
      (click)="openReply()"
      [disabled]="!selectedEmail"
    >
      <span class="material-symbols-outlined">reply</span>
      <span class="label">REPLY</span>
    </button>
    <button class="filter-btn" (click)="toggleDelete()">
      <span class="material-symbols-outlined">{{
        showDeleted ? "restore" : "delete"
      }}</span>
      <span class="label">{{ showDeleted ? "UNDELETE" : "DELETE" }}</span>
    </button>
    <button
      class="filter-btn"
      (click)="toggleDelete()"
      [disabled]="!selectedEmail || deleteInFlight"
      *ngIf="aiDeleteEnabled"
    >
      <span class="material-symbols-outlined">auto_awesome</span>
      <span class="label">AI DELETE</span>
    </button>
    <button class="filter-btn" (click)="toggleSent()">
      <span class="material-symbols-outlined">outbox</span>
      <span class="label">{{ showSent ? "INBOX" : "SENT" }}</span>
    </button>
    <button class="filter-btn" (click)="archiveEmails()">
      <span class="material-symbols-outlined">{{
        showDeleted ? "inbox" : "archive"
      }}</span>
    </button>
  </div>
  <div class="inbox-body">
    <div class="email-list">
      <div
        class="email-item"
        *ngFor="let email of inbox"
        [class.selected]="email === selectedEmail"
        [class.unread]="!email.read"
        (click)="selectEmail(email)"
      >
        <div class="avatar" [class.fallback]="!email.senderAvatarUrl">
          <img
            *ngIf="email.senderAvatarUrl"
            [src]="email.senderAvatarUrl"
            [alt]="(email.displaySender || email.sender) + ' avatar'"
          />
          <span *ngIf="!email.senderAvatarUrl">{{ email.senderInitials }}</span>
        </div>
        <div class="email-meta">
          <div class="top-row">
            <div class="sender">{{ email.displaySender || email.sender }}</div>
            <div class="timestamp">{{ email.timestamp | date : "short" }}</div>
          </div>
          <div class="subject">{{ email.subject }}</div>
          <div class="preview-text">{{ email.preview }}</div>
        </div>
      </div>
    </div>
    <div class="email-preview" *ngIf="selectedEmail || showComposeBox">
      <ng-container *ngIf="showComposeBox; else emailReadView">
        <div class="compose-container">
          <div class="compose-header">
            <div class="compose-title">New Message</div>
            <button class="btn" type="button" (click)="closeCompose()">
              <span class="material-symbols-outlined">close</span>
              <span>Close</span>
            </button>
          </div>
          <div class="compose-field">
            <label>From</label>
            <div class="field-value">{{ meAddress }}</div>
          </div>
          <div class="compose-field">
            <label for="compose-to">To</label>
            <input
              id="compose-to"
              type="email"
              [(ngModel)]="composeTo"
              placeholder="name@example.com"
            />
          </div>
          <div class="compose-field">
            <label for="compose-subject">Subject</label>
            <input
              id="compose-subject"
              type="text"
              [(ngModel)]="composeSubject"
              placeholder="Subject"
            />
          </div>
          <div class="compose-field message-field">
            <label for="compose-body">Message</label>
            <textarea
              id="compose-body"
              rows="8"
              [(ngModel)]="composeBody"
              placeholder="Write your message..."
              (keydown)="onComposeKeydown($event)"
            ></textarea>
          </div>
          <div class="compose-actions">
            <button
              class="btn btn-primary"
              id="send-compose-btn"
              type="button"
              (click)="sendCompose()"
              [class.sending]="sendingCompose"
              [class.clicked]="composeClicked"
              [disabled]="sendingCompose"
            >
              <span class="material-symbols-outlined">send</span>
              <span>Send</span>
            </button>
            <button class="btn" type="button" (click)="closeCompose()">
              <span class="material-symbols-outlined">close</span>
              <span>Cancel</span>
            </button>
          </div>
          <div class="compose-error" *ngIf="composeError">
            {{ composeError }}
          </div>
        </div>
      </ng-container>
      <ng-template #emailReadView>
        <div *ngIf="showReplyBox" class="reply-composer">
          <div class="row">
            <span class="label">To</span
            ><span class="value">{{ selectedEmail?.sender }}</span>
          </div>
          <div class="row">
            <span class="label">Subject</span
            ><span class="value">{{ replySubject }}</span>
          </div>
          <textarea
            [(ngModel)]="replyText"
            rows="6"
            placeholder="Write your reply..."
            class="reply-textarea"
            (keydown)="onReplyKeydown($event)"
          ></textarea>
          <div class="actions">
            <button
              class="btn btn-primary"
              id="send-reply-btn"
              (click)="sendReply()"
              [class.sending]="sendingReply"
              [class.clicked]="clickedSend"
              [disabled]="sendingReply"
            >
              <span class="material-symbols-outlined">send</span>
              <span>Send</span>
            </button>
            <button class="btn" (click)="showReplyBox = false">
              <span class="material-symbols-outlined">close</span>
              <span>Cancel</span>
            </button>
          </div>
          <div class="original-sep">----- Original message -----</div>
        </div>

        <div class="email-content">
          <h2>{{ selectedEmail?.subject }}</h2>
          <div class="sender-row" *ngIf="selectedEmail">
            <div
              class="avatar"
              [class.fallback]="!selectedEmail.senderAvatarUrl"
            >
              <img
                *ngIf="selectedEmail.senderAvatarUrl"
                [src]="selectedEmail.senderAvatarUrl"
                [alt]="
                  (selectedEmail.displaySender || selectedEmail.sender) +
                  ' avatar'
                "
              />
              <span *ngIf="!selectedEmail.senderAvatarUrl">{{
                selectedEmail.senderInitials
              }}</span>
            </div>
            <div class="sender-details">
              <div class="sender-name">
                {{ selectedEmail.displaySender || selectedEmail.sender }}
              </div>
              <div class="sender-meta">
                <span class="label">From</span>
                <span class="value">{{ selectedEmail.sender }}</span>
                <span class="timestamp">{{
                  selectedEmail.timestamp | date : "short"
                }}</span>
              </div>
            </div>
          </div>
          <div
            *ngIf="selectedEmail?.banner"
            class="banner-wrapper"
            [ngClass]="{
              'banner-supereats': selectedEmail?.category === 'supereats',
              'banner-bank': selectedEmail?.category === 'bank',
              'banner-cadabra': selectedEmail?.category === 'cadabra',
              'banner-default':
                !selectedEmail?.category ||
                (selectedEmail?.category !== 'supereats' &&
                  selectedEmail?.category !== 'bank' &&
                  selectedEmail?.category !== 'cadabra')
            }"
          >
            <img
              *ngIf="selectedEmail?.category === 'supereats'"
              src="assets/notubereats.png"
              class="banner-img"
            />
            <img
              *ngIf="selectedEmail?.category === 'bank'"
              src="assets/notfifththird.png"
              class="banner-img"
            />
            <img
              *ngIf="selectedEmail?.category === 'cadabra'"
              src="assets/notamazon.png"
              class="banner-img"
            />
            <img
              *ngIf="
                selectedEmail?.banner &&
                (!selectedEmail?.category ||
                  (selectedEmail?.category !== 'supereats' &&
                    selectedEmail?.category !== 'bank' &&
                    selectedEmail?.category !== 'cadabra'))
              "
              src="assets/notubereats.png"
              class="banner-img"
            />
          </div>
          <div
            class="email-body"
            [innerHTML]="renderEmailBody(selectedEmailBody)"
          ></div>
        </div>
      </ng-template>
    </div>
  </div>
</div>
