<div class="content-container">
  <div class="header">
    <div class="title">Kanban</div>
  </div>

  <div class="content-body">
    <ng-template #assigneeBlock let-item>
      <div class="assign">
        <ng-container *ngIf="assigneeFor(item) as assignee; else unassignedAssignee">
          <div class="assignee-chip">
            <div class="avatar" [class.fallback]="!assignee.avatarUrl">
              <img
                *ngIf="assignee.avatarUrl"
                [src]="assignee.avatarUrl"
                [alt]="assignee.name + ' avatar'"
              />
              <span *ngIf="!assignee.avatarUrl">{{ assignee.initials }}</span>
            </div>
            <div class="assignee-meta">
              <div class="name">{{ assignee.name }}</div>
              <div class="title">{{ assignee.title }}</div>
            </div>
          </div>
        </ng-container>
        <ng-template #unassignedAssignee>
          <div class="assignee-chip unassigned">
            <div class="avatar fallback">
              <span class="material-symbols-outlined">person</span>
            </div>
            <div class="assignee-meta">
              <div class="name">Unassigned</div>
              <div class="title">Pick an assignee</div>
            </div>
          </div>
        </ng-template>
        <select (change)="reassign(item, $any($event.target).value)" [disabled]="item.status === 'done'">
          <option value="" [selected]="!item.assignee_id">Unassigned</option>
          <option *ngFor="let e of hires" [value]="e.id" [selected]="e.id === item.assignee_id">
            {{ e.name }} ({{ e.title }})
          </option>
        </select>
      </div>
    </ng-template>

    <div class="kanban">
      <div class="column" (dragover)="onDragOver($event)" (drop)="onDrop($event, 'todo')">
        <div class="col-header">
          <div class="col-title">Do</div>
          <div class="count">{{ todo.length }}</div>
        </div>
        <div class="cards">
          <div
            class="card"
            *ngFor="let it of todo"
            draggable="true"
            (dragstart)="onDragStart($event, it)"
          >
            <div class="card-title">{{ it.title }}</div>
            <ng-container *ngTemplateOutlet="assigneeBlock; context: { $implicit: it }"></ng-container>
            <div class="blockers" [attr.title]="blockerTitle(it)">Blockers: {{ remainingBlockers(it) }}</div>
            <div class="card-desc">{{ it.description }}</div>
          </div>
        </div>
      </div>

      <div class="column" (dragover)="onDragOver($event)" (drop)="onDrop($event, 'doing')">
        <div class="col-header">
          <div class="col-title">Doing</div>
          <div class="count">{{ doing.length }}</div>
        </div>
        <div class="cards">
          <div
            class="card doing"
            *ngFor="let it of doing"
            draggable="true"
            (dragstart)="onDragStart($event, it)"
          >
            <div class="card-title">{{ it.title }}</div>
            <ng-container *ngTemplateOutlet="assigneeBlock; context: { $implicit: it }"></ng-container>
            <div class="progress">
              <div class="bar"><div class="fill" [style.width.%]="progress(it)"></div></div>
              <div class="pct">{{ progress(it) }}%</div>
            </div>
            <div class="blockers" [attr.title]="blockerTitle(it)">Blockers: {{ remainingBlockers(it) }}</div>
            <div class="card-desc">{{ it.description }}</div>
          </div>
        </div>
      </div>

      <div class="column" (dragover)="onDragOver($event)" (drop)="onDrop($event, 'done')">
        <div class="col-header">
          <div class="col-title">Done</div>
          <div class="count">{{ done.length }}</div>
        </div>
        <div class="cards">
          <div
            class="card done"
            *ngFor="let it of done"
            [attr.draggable]="false"
          >
            <div class="card-title">{{ it.title }}</div>
            <ng-container *ngTemplateOutlet="assigneeBlock; context: { $implicit: it }"></ng-container>
            <div class="blockers" [attr.title]="blockerTitle(it)">Blockers: {{ remainingBlockers(it) }}</div>
            <div class="card-desc">{{ it.description }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
