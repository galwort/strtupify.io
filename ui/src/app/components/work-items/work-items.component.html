<div class="content-container">
  <div class="header">
    <div class="title">Kanban</div>
  </div>

  <div class="content-body">
    <ng-template #avatarBubble let-item>
      <ng-container *ngIf="hiresLoading; else avatarResolved">
        <div class="avatar-bubble skeleton" title="Loading assignee"></div>
      </ng-container>
      <ng-template #avatarResolved>
        <ng-container *ngIf="assigneeFor(item) as assignee; else avatarUnassigned">
          <div
            class="avatar-bubble"
            [class.fallback]="!assignee.avatarUrl"
            [attr.title]="assignee.name + (assignee.title ? ' - ' + assignee.title : '')"
          >
            <img
              *ngIf="assignee.avatarUrl"
              [src]="assignee.avatarUrl"
              [alt]="assignee.name + ' avatar'"
            />
            <span *ngIf="!assignee.avatarUrl">{{ assignee.initials }}</span>
          </div>
        </ng-container>
      </ng-template>
      <ng-template #avatarUnassigned>
        <div class="avatar-bubble fallback" title="Unassigned">
          <span class="material-symbols-outlined">person</span>
        </div>
      </ng-template>
    </ng-template>

    <ng-template #assignSelect let-item>
      <div class="assign">
        <select
          (change)="reassign(item, $any($event.target).value)"
          [disabled]="item.status === 'done' || hiresLoading"
        >
          <option value="" [selected]="!item.assignee_id">Unassigned</option>
          <option *ngFor="let e of hires" [value]="e.id" [selected]="e.id === item.assignee_id">
            {{ e.name }}{{ e.title ? ' - ' + e.title : '' }}
          </option>
        </select>
      </div>
    </ng-template>

    <div class="kanban">
      <div
        class="column"
        [class.drop-target]="dragHoverColumn === 'todo'"
        (dragover)="onDragOver($event, 'todo')"
        (dragleave)="onDragLeave('todo')"
        (drop)="onDrop($event, 'todo')"
      >
        <div class="col-header">
          <div class="col-title">Do</div>
          <div class="count">{{ todo.length }}</div>
        </div>
        <div class="cards">
          <div
            class="card"
            *ngFor="let it of todo"
            draggable="true"
            (dragstart)="onDragStart($event, it)"
            (dragend)="onDragEnd()"
          >
            <div class="card-header">
              <div class="card-title">{{ it.title }}</div>
              <ng-container *ngTemplateOutlet="avatarBubble; context: { $implicit: it }"></ng-container>
            </div>
            <ng-container *ngTemplateOutlet="assignSelect; context: { $implicit: it }"></ng-container>
            <div class="blockers" [attr.title]="blockerTitle(it)">Blockers: {{ remainingBlockers(it) }}</div>
            <div class="card-desc">{{ it.description }}</div>
          </div>
        </div>
      </div>

      <div
        class="column"
        [class.drop-target]="dragHoverColumn === 'doing'"
        (dragover)="onDragOver($event, 'doing')"
        (dragleave)="onDragLeave('doing')"
        (drop)="onDrop($event, 'doing')"
      >
        <div class="col-header">
          <div class="col-title">Doing</div>
          <div class="count">{{ doing.length }}</div>
        </div>
        <div class="cards">
          <div
            class="card doing"
            *ngFor="let it of doing"
            draggable="true"
            (dragstart)="onDragStart($event, it)"
            (dragend)="onDragEnd()"
          >
            <div class="card-header">
              <div class="card-title">{{ it.title }}</div>
              <ng-container *ngTemplateOutlet="avatarBubble; context: { $implicit: it }"></ng-container>
            </div>
            <ng-container *ngTemplateOutlet="assignSelect; context: { $implicit: it }"></ng-container>
            <div class="progress">
              <div class="bar"><div class="fill" [style.width.%]="progress(it)"></div></div>
              <div class="pct">{{ progress(it) }}%</div>
            </div>
            <div class="blockers" [attr.title]="blockerTitle(it)">Blockers: {{ remainingBlockers(it) }}</div>
            <div class="card-desc">{{ it.description }}</div>
          </div>
        </div>
      </div>

      <div
        class="column"
        (dragover)="onDragOver($event, 'done')"
        (dragleave)="onDragLeave('done')"
        (drop)="onDrop($event, 'done')"
      >
        <div class="col-header">
          <div class="col-title">Done</div>
          <div class="count">{{ done.length }}</div>
        </div>
        <div class="cards">
          <div
            class="card done"
            *ngFor="let it of done"
            [attr.draggable]="false"
          >
            <div class="card-header">
              <div class="card-title">{{ it.title }}</div>
              <ng-container *ngTemplateOutlet="avatarBubble; context: { $implicit: it }"></ng-container>
            </div>
            <ng-container *ngTemplateOutlet="assignSelect; context: { $implicit: it }"></ng-container>
            <div class="blockers" [attr.title]="blockerTitle(it)">Blockers: {{ remainingBlockers(it) }}</div>
            <div class="card-desc">{{ it.description }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
