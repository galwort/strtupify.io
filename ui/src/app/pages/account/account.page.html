<ion-content>
  <ng-container *ngIf="!loading && viewModel as vm; else accountState">
    <div class="page-container">
      <div class="header">
        <div class="title">Account</div>
      </div>

      <div class="account-content">
        <section class="profile-container">
          <div class="top-row">
            <div class="logo" [class.has-photo]="profilePhotoUrl">
              <input
                #photoInput
                type="file"
                accept="image/*"
                class="sr-only"
                (change)="onPhotoSelected($event)"
              />
              <ng-container *ngIf="profilePhotoUrl; else profilePlaceholder">
                <img [src]="profilePhotoUrl" alt="Profile photo" />
              </ng-container>
              <ng-template #profilePlaceholder>
                <span class="material-symbols-outlined"> account_circle </span>
              </ng-template>
              <button
                type="button"
                class="edit-icon"
                (click)="photoInput.click()"
                [disabled]="photoUploading"
                aria-label="Change profile photo"
              >
                <span class="material-symbols-outlined" *ngIf="!photoUploading">
                  edit
                </span>
                <span class="edit-spinner" *ngIf="photoUploading"></span>
              </button>
            </div>
            <p class="error" *ngIf="photoError">{{ photoError }}</p>
          </div>
          <h1 class="name">
            {{ vm.profile?.username || vm.user.displayName || 'Your Account' }}
          </h1>
          <p class="description">{{ vm.user.email }}</p>

          <div class="section">
            <div class="row">
              <div class="label">Display Name</div>
              <div class="value">
                {{ vm.user.displayName || vm.profile?.loginUsername || '--' }}
              </div>
            </div>
            <div class="row">
              <div class="label">Email</div>
              <div class="value">{{ vm.user.email || '--' }}</div>
            </div>
            <div class="row">
              <div class="label">Account Created</div>
              <div class="value">
                {{ vm.user.metadata.creationTime | date: 'medium' }}
              </div>
            </div>
            <div class="row">
              <div class="label">Last Sign In</div>
              <div class="value">
                {{ vm.user.metadata.lastSignInTime | date: 'medium' }}
              </div>
            </div>
            <div class="row">
              <div class="label">Companies</div>
              <div class="value">{{ vm.profile?.companyIds?.length || 0 }}</div>
            </div>
          </div>
        </section>

        <section class="section certifications" *ngIf="achievements.length">
          <div class="section-header">
            <div class="label">Certifications</div>
            <div class="value">{{ achievements.length }}</div>
          </div>
          <div class="badge-grid">
            <button
              type="button"
              class="badge-card"
              *ngFor="let badge of achievements"
              (click)="openBadgeModal(badge)"
              [attr.aria-label]="'View ' + badge.name + ' badge'"
            >
              <img
                [src]="badge.imageUrl"
                [alt]="badge.description || badge.name"
                loading="lazy"
              />
              <div class="badge-name">{{ badge.name }}</div>
              <div class="badge-earned" *ngIf="badge.earnedAt">
                Earned {{ badge.earnedAt | date: 'mediumDate' }}
              </div>
            </button>
          </div>
        </section>

        <div class="actions">
          <p *ngIf="errorMessage" class="error">{{ errorMessage }}</p>
          <button
            type="button"
            class="sign-out"
            (click)="signOut()"
            [disabled]="signingOut"
          >
            {{ signingOut ? 'Signing out...' : 'Sign out' }}
          </button>
        </div>
      </div>
    </div>
  </ng-container>

  <div
    class="badge-modal-backdrop"
    *ngIf="activeBadge as badge"
    (click)="closeBadgeModal()"
  >
    <div
      class="badge-modal"
      role="dialog"
      aria-modal="true"
      [attr.aria-label]="badge.name"
      (click)="$event.stopPropagation()"
    >
      <button
        type="button"
        class="badge-modal-close"
        (click)="closeBadgeModal()"
        aria-label="Close badge details"
      >
        <span class="material-symbols-outlined"> close </span>
      </button>
      <img
        class="badge-modal-image"
        [src]="badge.imageUrl"
        [alt]="badge.description || badge.name"
      />
      <div class="badge-modal-title">{{ badge.name }}</div>
      <div class="badge-modal-description">
        {{ badge.description }}
      </div>
      <div class="badge-modal-meta" *ngIf="badge.earnedAt">
        Earned {{ badge.earnedAt | date: 'medium' }}
      </div>
    </div>
  </div>

  <ng-template #accountState>
    <div class="account-state">
      <div class="spinner" *ngIf="loading"></div>
      <p *ngIf="loading">Loading your account...</p>
      <p *ngIf="!loading">No account information available.</p>
      <p *ngIf="errorMessage" class="error">{{ errorMessage }}</p>
    </div>
  </ng-template>
</ion-content>

